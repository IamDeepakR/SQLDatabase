WITH MOST_VISITED_FLOOR AS( 
 	SELECT
    NAME, FLOOR, COUNT(FLOOR) AS FLR_VISIT_CNT,RANK() OVER(PARTITION BY NAME ORDER BY COUNT(FLOOR) DESC) AS FLR_VISIT_CNT_RANK
    FROM ENTRIES
    GROUP BY NAME, FLOOR
),

 NO_OF_VISTS(NAME, NO_OF_VISTS) AS (
SELECT NAME, COUNT(*) AS NO_OF_VISTS 
FROM ENTRIES 
GROUP BY NAME
order by NAME), 

RESOURCE_USED(NAME, RESOURCES_USED) AS(
SELECT DISTINCT NAME, LISTAGG(RESOURCES, ',')  WITHIN GROUP(ORDER BY RESOURCES)  OVER(PARTITION BY NAME) AS RESOURCES_USED
FROM ( SELECT DISTINCT RESOURCES,NAME FROM entries ) 
) 

SELECT NO_OF_VISTS.NAME, NO_OF_VISTS.NO_OF_VISTS, MOST_VISITED_FLOOR.Floor AS MOST_VISITED_FLOOR, RESOURCE_USED.RESOURCES_USED
FROM RESOURCE_USED 
INNER JOIN NO_OF_VISTS 
	ON RESOURCE_USED.NAME = NO_OF_VISTS.NAME
INNER JOIN MOST_VISITED_FLOOR 
    ON NO_OF_VISTS.NAME = MOST_VISITED_FLOOR.NAME
WHERe MOST_VISITED_FLOOR.FLR_VISIT_CNT_RANK = 1


     
